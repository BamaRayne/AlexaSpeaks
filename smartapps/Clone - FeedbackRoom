/* 
 * Rooms - EchoSistant Add-on 
 *
 *		12/31/2016		Release 4.1.1	New features: status updates, custom commands, weather alerts, message reminders 
 *										Improvements: streamlined UI and processing
 *
 *  Copyright 2016 Jason Headley & Bobby Dobrescu
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except
 *  in compliance with the License. You may obtain a copy of the License at:
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software distributed under the License is distributed
 *  on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License
 *  for the specific language governing permissions and limitations under the License.
 *
/**********************************************************************************************************************************************/
definition(
	name			: "FeedbackProfile",
    namespace		: "Clone",
    author			: "JH/BD",
	description		: "EchoSistant Add-on",
	category		: "My Apps",
    parent			: "Clone:Clone",
	iconUrl			: "https://raw.githubusercontent.com/BamaRayne/Echosistant/master/smartapps/bamarayne/echosistant.src/app-Echosistant.png",
	iconX2Url		: "https://raw.githubusercontent.com/BamaRayne/Echosistant/master/smartapps/bamarayne/echosistant.src/app-Echosistant@2x.png",
	iconX3Url		: "https://raw.githubusercontent.com/BamaRayne/Echosistant/master/smartapps/bamarayne/echosistant.src/app-Echosistant@2x.png")
/**********************************************************************************************************************************************/


preferences {

    page name: "mainProfilePage"
    		page name: "pFeedbackScene"          
        	page name: "pFeedbackConfig"
        	page name: "pScenes"
        	page name: "pRestrict"
  			page name: "certainTime"
            
}
page name: "mainProfilePage"
    def mainProfilePage() {
        dynamicPage (name: "mainProfilePage", install: true, uninstall: true) {
        section ("Activate and Deactivate Feedback"){
            href "pFeedbackConfig", title: "Activate and Deactivate Alexa BackTalks Messages", description: none,
            image: "https://raw.githubusercontent.com/BamaRayne/Echosistant/master/smartapps/bamarayne/echosistant.src/Echosistant_Rest.png"
        	}
        if (!fallFeedback) {
        section("") {
        paragraph ("All Custom Feedback Messages have been disabled.  Activate 'All Feedback Messages' to configure this section")
        	}
        }
		if (fallFeedback) {
        section ("Switches and Dimmers", hideWhenEmpty: true) {
            if (faudioTextOn || faudioTextOff || speech11 || music11) paragraph "Configured with Settings"
            if (fSwitchesAndDimmers) {
            	input "fShowSwitches", "bool", title: "Switches and Dimmers", default: false, submitOnChange: true
            if (fShowSwitches) {        
                input "faudioTextOn", "text", title: "Alexa says this...", description: "...when the last event was on", required: false, capitalization: "sentences"
                input "faudioTextOff", "text", title: "Alexa says this...", description: "...when the last event was off", required: false, capitalization: "sentences"
                input "speech11", "capability.speechSynthesis", title: "Optional send Alexa Feedback to this Message Player", required: false, multiple: true, submitOnChange: true
                input "music11", "capability.musicPlayer", title: "Optional send Alexa Feedback to this Sonos Type Devices", required: false, multiple: true, submitOnChange: true
                if (music11) {
                    input "volume11", "number", title: "Temporarily change volume", description: "0-100%", required: false
                    input "resumePlaying11", "bool", title: "Resume currently playing music after notification", required: false, defaultValue: false
                	}
                }
            }             
        }
        section("Doors and Windows", hideWhenEmpty: true) {
            if (fAudioTextOpen || fAudioTextClosed || speech12 || music12) paragraph "Configured with Settings"
            if (fDoorsAndWindows) {
            input "fShowContacts", "bool", title: "Doors and Windows", default: false, multiple: false, submitOnChange: true
            if (fShowContacts) {
                input "fAudioTextOpen", "text", title: "Alexa says this...", description: "...when the last event was door opened", required: false, capitalization: "sentences"
                input "fAudioTextClosed", "text", title: "Alexa says this...", description: "...when the last event was door closed", required: false, capitalization: "sentences"
                input "speech12", "capability.speechSynthesis", title: "Optional send Alexa Feedback to this Message Player", required: false, multiple: true, submitOnChange: true
                input "music12", "capability.musicPlayer", title: "Optional send Alexa Feedback to this Sonos Type Devices", required: false, multiple: true, submitOnChange: true
                if (music12) {
                    input "volume12", "number", title: "Temporarily change volume", description: "0-100%", required: false
                    input "resumePlaying12", "bool", title: "Resume currently playing music after notification", required: false, defaultValue: false
                	}
                }
            }
        }       
        section("Locks", hideWhenEmpty: true) {
            if (fAudioTextLocked || fAudioTextUnlocked || speech13 || music13) paragraph "Configured with Settings"
            if (fLocks) {
            input "fShowLocks", "bool", title: "Locks", default: false, submitOnChange: true
            if (fShowLocks) {
                input "fAudioTextLocked", "text", title: "Alexa says this...", description: "...when the last event was locked", required: false, capitalization: "sentences"
                input "fAudioTextUnlocked", "text", title: "Alexa says this...", description: "...when the last event was door unlocked", required: false, capitalization: "sentences"
                input "speech13", "capability.speechSynthesis", title: "Optional send Alexa Feedback to this Message Player", required: false, multiple: true, submitOnChange: true
                input "music13", "capability.musicPlayer", title: "Optional send Alexa Feedback to this Sonos Type Devices", required: false, multiple: true, submitOnChange: true
                if (music13) {
                    input "volume13", "number", title: "Temporarily change volume", description: "0-100%", required: false
                    input "resumePlaying13", "bool", title: "Resume currently playing music after notification", required: false, defaultValue: false
                	}
                }
            }
        }       
        section("Motion Sensors", hideWhenEmpty: true) {
            if (fAudioTextActive || fAudioTextInactive || speech14 || music14) paragraph "Configured with Settings"
            if (fMotion) {
            input "fShowMotion", "bool", title: "Motion Sensors", default: false,  submitOnChange: true
            if (fShowMotion) {
                input "fAudioTextActive", "text", title: "Alexa says this...", description: "...when the last motion event was active", required: false, capitalization: "sentences"
                input "fAudioTextInactive", "text", title: "Alexa says this...", description: "...when the last motion event was inactive", required: false, capitalization: "sentences"
                input "speech14", "capability.speechSynthesis", title: "Optional send Alexa Feedback to this Message Player", required: false, multiple: true, submitOnChange: true
                input "music14", "capability.musicPlayer", title: "Optional send Alexa Feedback to this Sonos Type Devices", required: false, multiple: true, submitOnChange: true
                if (music14) {
                    input "volume14", "number", title: "Temporarily change volume", description: "0-100%", required: false
                    input "resumePlaying14", "bool", title: "Resume currently playing music after notification", required: false, defaultValue: false
                	}
                }
            }
        }        
        section("Presence Sensors", hideWhenEmpty: true) {
        	if (fAudioTextPresent || fAudioTextNotPresent || speech15 || music15) paragraph "Configured with Settings"
            if (fPresence) {
            input "fShowPresence", "bool", title: "Presence Sensors", default: false, submitOnChange: true
            if (fShowPresence) {
                input "fAudioTextPresent", "text", title: "Alexa says this...", description: "...when the last event was arrived", required: false, capitalization: "sentences"
                input "fAudioTextNotPresent", "text", title: "Alexa says this...", description: "...when the last event was not home", required: false, capitalization: "sentences"
                input "speech15", "capability.speechSynthesis", title: "Optional send Alexa Feedback to this Message Player", required: false, multiple: true, submitOnChange: true
                input "music15", "capability.musicPlayer", title: "Optional send Alexa Feedback to this Sonos Type Devices", required: false, multiple: true, submitOnChange: true
                if (music15) {
                    input "volume15", "number", title: "Temporarily change volume", description: "0-100%", required: false
                    input "resumePlaying15", "bool", title: "Resume currently playing music after notification", required: false, defaultValue: false
                	}
                }
			}
		}         
        section("Thermostats", hideWhenEmpty: true) {
        	if (fAudioTextHeating || fAudioTextCooling || speech18 || music18) paragraph "Configured with Settings"
            if (fTStats) {
            	input "fShowTstat", "bool", title: "Thermostats", default: false, submitOnChange: true
            if (fShowTstat) {
                input "fAudioTextHeating", "text", title: "Alexa says this...", description: "Message to play when the Heating Set Point Changes", required: false, capitalization: "sentences"
                input "fAudioTextCooling", "text", title: "Alexa says this...", description: "Message to play when the Cooling Set Point Changes", required: false, capitalization: "sentences" 
                input "speech18", "capability.speechSynthesis", title: "Message Player", required: false, multiple: true, submitOnChange: true
                input "music18", "capability.musicPlayer", title: "On this Sonos Type Devices", required: false, multiple: true, submitOnChange: true
                if (music18) {
                    input "volume18", "number", title: "Temporarily change volume", description: "0-100%", required: false
                    input "resumePlaying18", "bool", title: "Resume currently playing music after notification", required: false, defaultValue: false
                	}
                }
			}		
        }
        section("Weather", hideWhenEmpty: true) {
        	if (fAudioTextWeather || speech19 || music19) paragraph "Configured with Settings"
            if (fWeather) {
            input "fShowWeather", "bool", title: "Weather Alerts", default: false, submitOnChange: true
            if (fShowWeather) {
                input "fAudioTextWeather", "text", title: "Alexa says this...", description: "When a Weather Alert is in effect", required: false, capitalization: "sentences"
                input "speech19", "capability.speechSynthesis", title: "Message Player", required: false, multiple: true, submitOnChange: true
                input "music19", "capability.musicPlayer", title: "On this Sonos Type Devices", required: false, multiple: true, submitOnChange: true
                if (music19) {
                    input "volume19", "number", title: "Temporarily change volume", description: "0-100%", required: false
                    input "resumePlaying19", "bool", title: "Resume currently playing music after notification", required: false, defaultValue: false
                        }
                    }
                }		
            }
            section ("Create Profile Scenes") {
            	href "pScenes", title: "Create Scenes... ", 
   				image: "https://raw.githubusercontent.com/BamaRayne/Echosistant/master/smartapps/bamarayne/echosistant.src/Echosistant_Media.png"   			
				}
            section ("Using these Restrictions") {
                href "pRestrict", title: "Use these restrictions... ", 
   				image: "https://raw.githubusercontent.com/BamaRayne/Echosistant/master/smartapps/bamarayne/echosistant.src/Echosistant_Media.png"   			
				}
            section ("Name and/or Remove this Profile") {
 		   	label title:"              Rename Profile ", required:false, defaultValue: "New Feedback Profile"  
        	}
		}
    }
}


page name: "pFeedbackScene"
	def pFeedbackScene() {
	dynamicPage (name: "pFeedbackScene", title: "", install: false, uninstall: false) {
		if (childApps.size()) { 
	section(childApps.size()==1 ? "One Scene configured" : childApps.size() + " Scenes configured" )
		}
	section("Scenes"){
		app(name: "scenes", appName: "Scenes", namespace: "bd", title: "View and Create Feedback Scenes for this Room", multiple: true,  uninstall: false)
		} 
	} 
} 

page name: "pFeedbackConfig"    
    def pFeedbackConfig(){
        dynamicPage(name: "pFeedbackConfig", title: "Choose from the available Notifications",install: false, uninstall: false) {
            section ("Activate/DeActivate Feedback", hideWhenEmpty: true){
            paragraph "To mute a notification, disable its toggle \n" +
            "To mute all feedbacks, disable the All Feedbacks toggle"
            input "fallFeedback", "bool", title: "Turn on to Activate the Notifications Section", default: false, submitOnChange: true
            input "fSwitchesAndDimmers", "bool", title: "Switches and Dimmers", default: false, submitOnChange: true
            input "fDoorsAndWindows", "bool", title: "Doors and Windows", default: false, submitOnChange: true
            input "fLocks", "bool", title: "Locks", default: false, submitOnChange: true
            input "fMotion", "bool", title: "Motion Sensors", default: false, submitOnChange: true
            input "fPresence", "bool", title: "Presence Sensors", default: false, submitOnChange: true
            input "fTStats", "bool", title: "Thermostats", default: false, submitOnChange: true
            input "fWeather", "bool", title: "Weather Alerts", default: false, submitOnChange: true
		}
    }
}

          
page name: "pScenes"    
    def pScenes() {
        dynamicPage (name: "pScenes", title: "", install: true, uninstall: false) {
        	if (childApps.size()) { 
            	section(childApps.size()==1 ? "One Scene configured" : childApps.size() + " Scenes configured" )
            }
            if (childApps.size()) {  
            	section("Scenes",  uninstall: false){
                	app(name: "scenes", appName: "scenes", namespace: "Clone", title: "Create a new scene for this Profile", multiple: true,  uninstall: false)
            	}
            }
            else {
            	section("Scenes",  uninstall: false){
            		paragraph "NOTE: Looks like you have no Scenes yet, please make sure you have installed the Scenes Smart App Add-on before creating a new Scene!"
            		app(name: "scenes", appName: "scenes", namespace: "Clone", title: "Create a new scene for this Profile", multiple: true,  uninstall: false)
        		}
            }
       }
}
page name: "pRestrict"
    def pRestrict(){
        dynamicPage(name: "pRestrict", title: "", uninstall: false) {
			section ("Mode Restrictions") {
                input "modes", "mode", title: "Only when mode is", multiple: true, required: false, submitOnChange: true,
                image: "https://raw.githubusercontent.com/BamaRayne/Echosistant/master/smartapps/bamarayne/echosistant.src/Echosistant_Extra.png"
            }        
            section ("Days - Audio only on these days"){	
                input "days", title: "Only on certain days of the week", multiple: true, required: false, submitOnChange: true,
                    "enum", options: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
                    image: "https://raw.githubusercontent.com/BamaRayne/Echosistant/master/smartapps/bamarayne/echosistant.src/Echosistant_Extra.png"
            }
            section ("Time - Audio only during these times"){
                href "certainTime", title: "Only during a certain time", description: timeIntervalLabel ?: "Tap to set", state: timeIntervalLabel ? "complete" : null,
                image: "https://raw.githubusercontent.com/BamaRayne/Echosistant/master/smartapps/bamarayne/echosistant.src/Echosistant_Extra.png"
            }   
	    }
	}
page name: "certainTime"
    def certainTime() {
        dynamicPage(name:"certainTime",title: "Only during a certain time", uninstall: false) {
            section("Beginning at....") {
                input "startingX", "enum", title: "Starting at...", options: ["A specific time", "Sunrise", "Sunset"], required: false , submitOnChange: true
                if(startingX in [null, "A specific time"]) input "starting", "time", title: "Start time", required: false, submitOnChange: true
                else {
                    if(startingX == "Sunrise") input "startSunriseOffset", "number", range: "*..*", title: "Offset in minutes (+/-)", required: false, submitOnChange: true
                    else if(startingX == "Sunset") input "startSunsetOffset", "number", range: "*..*", title: "Offset in minutes (+/-)", required: false, submitOnChange: true
                }
            }
            section("Ending at....") {
                input "endingX", "enum", title: "Ending at...", options: ["A specific time", "Sunrise", "Sunset"], required: false, submitOnChange: true
                if(endingX in [null, "A specific time"]) input "ending", "time", title: "End time", required: false, submitOnChange: true
                else {
                    if(endingX == "Sunrise") input "endSunriseOffset", "number", range: "*..*", title: "Offset in minutes (+/-)", required: false, submitOnChange: true
                    else if(endingX == "Sunset") input "endSunsetOffset", "number", range: "*..*", title: "Offset in minutes (+/-)", required: false, submitOnChange: true
                }
            }
        }
    }
    

def installed() {
	log.debug "Installed with settings: ${settings}"
}

def updated() {
	log.debug "Updated with settings: ${settings}"
	unsubscribe()
	initialize()
    def cScenes = getChildApps()
    if (parent.debug) "cScenes=${cScenes}"
}

def initialize() {
        state.lastMessage = null
    	state.lastTime  = null
        state.recording = null
}



/***********************************************************************************************************************
    LAST MESSAGE HANDLER
***********************************************************************************************************************/
def getLastMessage() {
	def cOutputTxt = "The last message sent to " + app.label + " was," + state.lastMessage + ", and it was sent at, " + state.lastTime
	return  cOutputTxt 
	if (parent.debug) log.debug "Sending last message to parent '${cOutputTxt}' "
}

/***********************************************************************************************************************
    RESTRICTIONS HANDLER
***********************************************************************************************************************/
private getAllOk() {
	modeOk && daysOk && timeOk
}
private getModeOk() {
    def result = !modes || modes?.contains(location.mode)
	if(debug) log.debug "modeOk = $result"
    result
} 
private getDayOk() {
    def result = true
if (days) {
		def df = new java.text.SimpleDateFormat("EEEE")
		if (location.timeZone) {
			df.setTimeZone(location.timeZone)
		}
		else {
			df.setTimeZone(TimeZone.getTimeZone("America/New_York"))
		}
		def day = df.format(new Date())
		result = days.contains(day)
	}
	if(debug) log.debug "daysOk = $result"
	result
}
private getTimeOk() {
	def result = true
	if ((starting && ending) ||
	(starting && endingX in ["Sunrise", "Sunset"]) ||
	(startingX in ["Sunrise", "Sunset"] && ending) ||
	(startingX in ["Sunrise", "Sunset"] && endingX in ["Sunrise", "Sunset"])) {
		def currTime = now()
		def start = null
		def stop = null
		def s = getSunriseAndSunset(zipCode: zipCode, sunriseOffset: startSunriseOffset, sunsetOffset: startSunsetOffset)
		if(startingX == "Sunrise") start = s.sunrise.time
		else if(startingX == "Sunset") start = s.sunset.time
		else if(starting) start = timeToday(starting,location.timeZone).time
		s = getSunriseAndSunset(zipCode: zipCode, sunriseOffset: endSunriseOffset, sunsetOffset: endSunsetOffset)
		if(endingX == "Sunrise") stop = s.sunrise.time
		else if(endingX == "Sunset") stop = s.sunset.time
		else if(ending) stop = timeToday(ending,location.timeZone).time
		result = start < stop ? currTime >= start && currTime <= stop : currTime <= stop || currTime >= start
	if (parent.debug) log.trace "getTimeOk = $result."
    }
    return result
}
private hhmm(time, fmt = "h:mm a") {
	def t = timeToday(time, location.timeZone)
	def f = new java.text.SimpleDateFormat(fmt)
	f.setTimeZone(location.timeZone ?: timeZone(time))
	f.format(t)
}
private offset(value) {
	def result = value ? ((value > 0 ? "+" : "") + value + " min") : ""
}
private timeIntervalLabel() {
	def result = ""
	if      (startingX == "Sunrise" && endingX == "Sunrise") result = "Sunrise" + offset(startSunriseOffset) + " to Sunrise" + offset(endSunriseOffset)
	else if (startingX == "Sunrise" && endingX == "Sunset") result = "Sunrise" + offset(startSunriseOffset) + " to Sunset" + offset(endSunsetOffset)
	else if (startingX == "Sunset" && endingX == "Sunrise") result = "Sunset" + offset(startSunsetOffset) + " to Sunrise" + offset(endSunriseOffset)
	else if (startingX == "Sunset" && endingX == "Sunset") result = "Sunset" + offset(startSunsetOffset) + " to Sunset" + offset(endSunsetOffset)
	else if (startingX == "Sunrise" && ending) result = "Sunrise" + offset(startSunriseOffset) + " to " + hhmm(ending, "h:mm a z")
	else if (startingX == "Sunset" && ending) result = "Sunset" + offset(startSunsetOffset) + " to " + hhmm(ending, "h:mm a z")
	else if (starting && endingX == "Sunrise") result = hhmm(starting) + " to Sunrise" + offset(endSunriseOffset)
	else if (starting && endingX == "Sunset") result = hhmm(starting) + " to Sunset" + offset(endSunsetOffset)
	else if (starting && ending) result = hhmm(starting) + " to " + hhmm(ending, "h:mm a z")
}
/***********************************************************************************************************************
    SMS HANDLER
***********************************************************************************************************************/
private void sendtxt(message) {
    if (parent.debug) log.debug "Request to send sms received with message: '${message}'"
    if (sendContactText) { 
        sendNotificationToContacts(message, recipients)
            if (parent.debug) log.debug "Sending sms to selected reipients"
    } 
    else {
    	if (push) { 
    		sendPush message
            	if (parent.debug) log.debug "Sending push message to selected reipients"
        }
    } 
    if (notify) {
        sendNotificationEvent(message)
             	if (parent.debug) log.debug "Sending notification to mobile app"

    }
    if (sms) {
        sendText(sms, message)
        if (parent.debug) log.debug "Processing message for selected phones"
	}
}
private void sendText(number, message) {
    if (sms) {
        def phones = sms.split("\\;")
        for (phone in phones) {
            sendSms(phone, message)
            if (parent.debug) log.debug "Sending sms to selected phones"
        }
    }
}
private txtFormat (message, eDev, eVal) {
    def eTxt = " " 
        if(message) {
        	message = message.replace('$device', "${eDev}")
        	message = message.replace('$action', "${eVal}")
	  	    eTxt = message
        }  	
            if (debug) log.debug "Processed Alert: ${eTxt} "
    		
            return eTxt
}
/************************************************************************************************************
   Play Sonos Alert
************************************************************************************************************/
def playAlert(message, speaker) {
    state.sound = textToSpeech(message instanceof List ? message[0] : message)
    speaker.playTrackAndResume(state.sound.uri, state.sound.duration, volume)
    if (debug) log.debug "Sending message: ${message} to speaker: ${speaker}"

}
